from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CallbackQueryHandler
import logging
import csv
import io
from datetime import datetime, date
import uuid
import json
from database import db 
from config import ADMIN_IDS
import keyboard

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    logging.info(f"üîß DEBUG: button_handler called with: {query.data}")
    
    # ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    user_id = query.from_user.id
    current_time = datetime.now().timestamp()
    
    if 'last_button_click' in context.user_data:
        last_click = context.user_data['last_button_click']
        if current_time - last_click < 1:  # 1 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –Ω–∞–∂–∞—Ç–∏—è–º–∏
            logging.info(f"‚ö° Fast click protection for user {user_id}")
            return
    
    context.user_data['last_button_click'] = current_time
    
    # ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞
    logging.info(f"üîÑ Button pressed: {query.data} by user {user_id}")
    
    if query.data == "payment_yookassa":
        await show_yookassa_payment(query, context)
    
    elif query.data == "payment_paypal":
        await show_paypal_payment(query, context)

    elif query.data == "check_yookassa_payment":
        await check_yookassa_payment(query, context)

    elif query.data == "check_paypal_payment":
        await check_paypal_payment(query, context)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    
    logging.info(f"New user: ID={user.id}, Name={user.first_name}, "
                 f"Username=@{user.username}, LastName={user.last_name}")
    try:
        db.get_or_create_user(
            user_id=user.id,
            username=user.username or "",  
            first_name=user.first_name or "",  
            last_name=user.last_name or ""  
        )
    except Exception as e:
        logging.error(f"Database error in /start: {e}")
        # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await update.message.reply_text("‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return
    
    if user.first_name:
        greeting = f"üåü –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}! üåü"
    else:
        greeting = f"üåü –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, @{user.username}! üåü"
    
    try:
        short_caption = f"""{greeting} –†–∞–¥–∞ –≤–∏–¥–µ—Ç—å –≤–∞—Å –Ω–∞ –∫—É—Ä—Å–µ "**–ü—É—Ç—å –∫ –º–µ—á—Ç–µ. –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è!**"

–ú–µ–Ω—è –∑–æ–≤—É—Ç **–°–≤–µ—Ç–ª–∞–Ω–∞ –°–∫—Ä–æ–º–æ–≤–∞** ‚Äî —è –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç.

–≠—Ç–æ 7-–¥–Ω–µ–≤–Ω—ã–π –∫—É—Ä—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –±–æ—Ç–∞. **–í —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é —Å –∑–∞–¥–∞–Ω–∏–µ–º 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏**.

–¶–µ–ª—å —ç—Ç–æ–≥–æ –ø—É—Ç–∏: –¥–∞—Ç—å –≤–∞–º —á–µ—Ç–∫–∏–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤–∞—à—É **–º–µ—á—Ç—É** –≤ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é, —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–ª—å**!

–ó–∞ —ç—Ç–∏ 7 –¥–Ω–µ–π –≤—ã:
üí´ –°–æ–ø—Ä–∏–∫–æ—Å–Ω–µ—Ç–µ—Å—å —Å–æ —Å–≤–æ–∏–º–∏ **–∏—Å—Ç–∏–Ω–Ω—ã–º–∏ –∂–µ–ª–∞–Ω–∏—è–º–∏** (–∞ –Ω–µ –Ω–∞–≤—è–∑–∞–Ω–Ω—ã–º–∏).
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç–µ –∏—Ö –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ **—Ü–µ–ª–∏**.
üöÄ –°–æ–∑–¥–∞–¥–∏—Ç–µ **–º–æ—â–Ω–æ–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ** –¥–ª—è –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏.

–ö—É—Ä—Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é, –Ω–æ –æ—á–µ–Ω—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É!
        """
        await update.message.reply_text(
            short_caption,
            parse_mode='Markdown'
        )
        
        welcome_text_1 = f"""    
üí° –ì–ª–∞–≤–Ω—ã–π –°–µ–∫—Ä–µ—Ç –ò—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ñ–µ–ª–∞–Ω–∏–π:

–Ø –∑–∞–º–µ—Ç–∏–ª–∞ –ø—Ä–æ—Å—Ç—É—é –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å: —É –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ **—É–º–µ—é—Ç –º–µ—á—Ç–∞—Ç—å** –∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞—é—Ç **–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —É—Å–∏–ª–∏—è**, –∂–µ–ª–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–±—ã–≤–∞—é—Ç—Å—è! üöÄ

–ú–Ω–æ–≥–∏–µ, –∫—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è–ª —Å–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π, —Å–ø—É—Å—Ç—è –≥–æ–¥—ã —Å —É–¥–∏–≤–ª–µ–Ω–∏–µ–º –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–ª–∏, —á—Ç–æ –ø–æ—á—Ç–∏ **–≤—Å—ë –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å**!

–ó–¥–µ—Å—å —Å—Ä–∞–±–æ—Ç–∞–ª–æ –ø—Ä–∞–≤–∏–ª–æ: **—á–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∂–µ–ª–∞–Ω–∏–µ, –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤–æ –í—Å–µ–ª–µ–Ω–Ω—É—é –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.**
        """
        await update.message.reply_text(
            welcome_text_1,
            parse_mode='Markdown'
        )
        
        welcome_text_2 = f"""
üôè –í–∞–∂–Ω–∞—è –°–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è: –í–ï–†–ê!

–°–µ–∫—Ä–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–µ, –Ω–æ –∏ –≤ **–∏—Å–∫—Ä–µ–Ω–Ω–µ–π –≤–µ—Ä–µ** –≤ —É—Å–ø–µ—Ö. –ê —Ç–∞–∫–∂–µ ‚Äî –≤ **–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π** –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—á—Ç—ã.

‚ö†Ô∏è –ï—Å–ª–∏ –≤—ã –ø–æ–ª–Ω—ã —Å–∫–µ–ø—Ç–∏—Ü–∏–∑–º–∞ –∏ –ø—Ä–∏—à–ª–∏, —á—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å "—ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" ‚Äî –Ω–∞—à –ø—É—Ç—å —Ä–∞–∑–æ–π–¥–µ—Ç—Å—è. –ö—É—Ä—Å –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –≥–æ—Ç–æ–≤ –≤–µ—Ä–∏—Ç—å –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.

‚ú® –í—ã –≥–æ—Ç–æ–≤—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–≤–æ–π "**–ü—É—Ç—å –∫ –º–µ—á—Ç–µ**" –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Å–æ–±–æ–π —Å–ª–µ–¥—É—é—â–∏–µ 7 –¥–Ω–µ–π?
        """
        await update.message.reply_text(
            welcome_text_2,
            parse_mode='Markdown'
        )
        
        welcome_text_3 = f"""
üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ!

–í—ã —É–∂–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å —Å–æ –º–Ω–æ–π –∏ —É–∑–Ω–∞–ª–∏ –≥–ª–∞–≤–Ω—É—é –∏–¥–µ—é –∫—É—Ä—Å–∞. –ï—Å–ª–∏ –≤—ã —Å–æ–≥–ª–∞—Å–Ω—ã —Å –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ –∏ –≥–æ—Ç–æ–≤—ã –∫ —Å–µ—Ä—å–µ–∑–Ω–æ–π —Ä–∞–±–æ—Ç–µ ‚Äî –º—ã –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.

‚úÖ **–°—Ç–æ–∏–º–æ—Å—Ç—å 7-–¥–Ω–µ–≤–Ω–æ–≥–æ –∫—É—Ä—Å–∞ –≤—Å–µ–≥–æ 599 —Ä—É–±–ª–µ–π –∏–ª–∏ 30 —à–µ–∫–µ–ª–µ–π.**

–î–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (7 –¥–Ω–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–æ—Å—Ç—É–ø –Ω–∞ 14 –¥–Ω–µ–π) –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:

üá∑üá∫ *–û–ø–ª–∞—Ç–∞ –∏–∑ –†–æ—Å—Å–∏–∏* (—Ä—É–±–ª–∏)
üåç *–û–ø–ª–∞—Ç–∞ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞* (—à–µ–∫–µ–ª–∏)

–û–±–µ —Å–∏—Å—Ç–µ–º—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –æ–ø–ª–∞—Ç—É –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏.
"""
        await update.message.reply_text(
            welcome_text_3,
            reply_markup=keyboard.get_payment_method_keyboard(),
            parse_mode='Markdown'
        )
    
    except Exception as e:
        logging.error(f"‚ùå Error in start handler: {e}")

async def show_yookassa_payment(query, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –ÆKassa"""
    payment_text = """
üí≥ *–û–ø–ª–∞—Ç–∞ –∏–∑ –†–æ—Å—Å–∏–∏*

‚úÖ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* 599 —Ä—É–±–ª–µ–π

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É *¬´–û–ø–ª–∞—Ç–∏—Ç—å 599‚ÇΩ¬ª* –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø –∫ –∫—É—Ä—Å—É –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç.

–ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è, –Ω–∞–∂–º–∏—Ç–µ *¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª*.
    """
    
    await update.message.reply_text(
        payment_text,
        reply_markup=keyboard.get_yookassa_payment_keyboard(),
        parse_mode='Markdown'
    )

async def show_paypal_payment(query, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ PayPal"""
    payment_text = """
üí≥ *–û–ø–ª–∞—Ç–∞ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞*

‚úÖ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* 30 —à–µ–∫–µ–ª–µ–π (‚Ç™)

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É *¬´–û–ø–ª–∞—Ç–∏—Ç—å 30‚Ç™¬ª* –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø –∫ –∫—É—Ä—Å—É –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç.

–ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è, –Ω–∞–∂–º–∏—Ç–µ *¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª*.
    """
    
    await update.message.reply_text(
        payment_text,
        reply_markup=keyboard.get_paypal_payment_keyboard(),
        parse_mode='Markdown'
    )

async def check_yookassa_payment(query, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa (–∑–∞–≥–ª—É—à–∫–∞)"""
    await query.answer(
        text="üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã...\n\n–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        show_alert=True
    )

async def check_paypal_payment(query, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ PayPal (–∑–∞–≥–ª—É—à–∫–∞)"""
    await query.answer(
        text="üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã...\n\n–ü–ª–∞—Ç–µ–∂ –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        show_alert=True
    )
